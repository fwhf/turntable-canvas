'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var TurntableCanvas=function(){function TurntableCanvas(dom,config,get,cb){_classCallCheck(this,TurntableCanvas);this.dom=dom;this.width=config.width||300;this.height=config.width||300;this.boundary=config.boundary||1;this.zhizhen={width:config.zhizhen&&config.zhizhen.width||50,src:config.zhizhen&&config.zhizhen.src||'http://blog.fwhf.xyz/img/turntable-canvas/zhizhen.png'};this.bg={width:config.bg&&config.bg.width||20,color:config.bg&&config.bg.color||'rgb(255,185,74)',lampNum:config.bg&&config.bg.lampNum||12,twinkleType:config.bg&&config.bg.twinkleType||0,lampColor:config.bg&&config.bg.lampColor||['rgb(255,255,255)','rgb(255,234,119)'],lampRadius:config.bg&&config.bg.lampRadius||3,twinkleTime:config.bg&&config.bg.twinkleTime||500};this.prize={bgColor:config.prize&&config.prize.bgColor||['rgb(255,233,204)','rgb(255,247,235)'],textColor:config.prize&&config.prize.textColor||'rgb(214,155,94)',textStyle:config.prize&&config.prize.textStyle||"16px Georgia",textTop:config.prize&&config.prize.textTop||14,imgTop:config.prize&&config.prize.imgTop||40,imgWidth:config.prize&&config.prize.imgWidth||32,imgHeight:config.prize&&config.prize.imgHeight||32};this.prizeList=config.prizeList;this.deviation=0;for(var i=0;i<this.prizeList.length;){if(i*360/this.prizeList.length>270){this.deviation=i*360/this.prizeList.length-270;break;}else{i++;}}
this.rotate=180/this.prizeList.length-this.deviation;this.get=get;this.cb=cb;this.init();}
_createClass(TurntableCanvas,[{key:'init',value:function init(){var _this=this;this.time=new Date().getTime();this.dom.classList.add("turntable-canvas");this.dom.style['width']=this.width+'px';this.dom.style['height']=this.height+'px';this.dom.innerHTML='<canvas class="turntable-canvas-bg '+this.time+'bg" width="'+this.width+'" height="'+this.height+'"></canvas><canvas class="turntable-canvas-content '+this.time+'content" width="'+this.width+'" height="'+this.height+'"></canvas><img class="turntable-canvas-zhizhen" width="'+this.zhizhen.width+'"src="'+this.zhizhen.src+'">';this.bgCanvas=document.getElementsByClassName(this.time+'bg')[0];this.bgCanvasContext=this.bgCanvas.getContext('2d');this.contentCanvas=document.getElementsByClassName(this.time+'content')[0];this.contentCanvasContext=this.contentCanvas.getContext('2d');this.contentCanvas.style.transform='rotate('+this.rotate+'deg)';document.getElementsByClassName('turntable-canvas-zhizhen')[0].onclick=function(){_this.start();};this.t=0;this.drawBg();this.drawContent();}},{key:'drawBg',value:function drawBg(){this.bgCanvasContext.clearRect(0,0,this.width,this.height);this.bgCanvasContext.beginPath();this.bgCanvasContext.fillStyle=this.bg.color;this.bgCanvasContext.arc(this.width/2,this.height/2,this.width/2,0,2*Math.PI);this.bgCanvasContext.fill();this.bgCanvasContext.closePath();for(var i=0;i<this.bg.lampNum;i++){this.bgCanvasContext.beginPath();this.bgCanvasContext.fillStyle=this.bg.lampColor[(i+this.t)%2];this.bgCanvasContext.arc(this.width/2+(this.width/2-this.bg.width/2)*Math.cos(360/this.bg.lampNum*i*Math.PI/180),this.height/2+(this.height/2-this.bg.width/2)*Math.sin(360/this.bg.lampNum*i*Math.PI/180),this.bg.lampRadius,0,2*Math.PI);this.bgCanvasContext.fill();this.bgCanvasContext.closePath();}}},{key:'drawContent',value:function drawContent(){var _this2=this;for(var i=0;i<this.prizeList.length;i++){this.contentCanvasContext.beginPath();this.contentCanvasContext.moveTo(this.width/2,this.height/2);this.contentCanvasContext.lineTo(this.width/2+(this.width/2-this.bg.width)*Math.cos(360/this.prizeList.length*i*Math.PI/180),this.height/2+(this.height/2-this.bg.width)*Math.sin(360/this.prizeList.length*i*Math.PI/180));this.contentCanvasContext.arc(this.width/2,this.height/2,this.width/2-this.bg.width,360/this.prizeList.length*Math.PI/180*i,360/this.prizeList.length*Math.PI/180*(i+1));this.contentCanvasContext.moveTo(this.width/2,this.height/2);this.contentCanvasContext.lineTo(this.width/2+(this.width/2-this.bg.width)*Math.cos(360/this.prizeList.length*(i+1)*Math.PI/180),this.height/2+(this.height/2-this.bg.width)*Math.sin(360/this.prizeList.length*(i+1)*Math.PI/180));this.contentCanvasContext.fillStyle=this.prize.bgColor[i%this.prize.bgColor.length];this.contentCanvasContext.fill();this.contentCanvasContext.closePath();}
var img=[];var _loop=function _loop(_i){img[_i]=document.createElement("img");img[_i].src=_this2.prizeList[_i].imgurl;img[_i].onload=function(){_this2.contentCanvasContext.save();_this2.contentCanvasContext.beginPath();_this2.contentCanvasContext.translate(_this2.width/2,_this2.height/2);_this2.contentCanvasContext.rotate((_this2.deviation-360/(_this2.prizeList.length*2)*(_i*2+1))*Math.PI/180);_this2.contentCanvasContext.translate(-_this2.width/2,-_this2.height/2);_this2.contentCanvasContext.fillStyle=_this2.prize.textColor;_this2.contentCanvasContext.font=_this2.prize.textStyle;_this2.contentCanvasContext.textAlign='center';_this2.contentCanvasContext.textBaseline='top';_this2.contentCanvasContext.fillText(_this2.prizeList[_i].text,_this2.width/2,_this2.bg.width+_this2.prize.textTop);_this2.contentCanvasContext.drawImage(img[_i],_this2.width/2-_this2.prize.imgWidth/2,_this2.bg.width+_this2.prize.imgTop,_this2.prize.imgWidth,_this2.prize.imgHeight);_this2.contentCanvasContext.closePath();_this2.contentCanvasContext.restore();};};for(var _i=0;_i<this.prizeList.length;_i++){_loop(_i);}}},{key:'start',value:function start(){var _this3=this;this.timerApi=setInterval(function(){_this3.rotate+=40;_this3.contentCanvas.style.transform='rotate('+_this3.rotate+'deg)';},100);this.timerTimeout=setInterval(function(){_this3.t=_this3.t==1?0:1;_this3.drawBg();},this.bg.twinkleTime);this.get(function(i){clearInterval(_this3.timerApi);_this3.rotate=0;_this3.rotateEnd=360*2+_this3.rand(360/_this3.prizeList.length*i+_this3.boundary,360/_this3.prizeList.length*(i+1)-_this3.boundary)-_this3.deviation;var speed=Math.ceil((_this3.rotateEnd-_this3.rotate)/20);_this3.timerInterval=setInterval(function(){speed=Math.ceil((_this3.rotateEnd-_this3.rotate)/20);if(_this3.rotate+speed>=_this3.rotateEnd){_this3.rotate=_this3.rotateEnd%360;_this3.rotateEnd=_this3.rotateEnd%360;var prize=Math.floor((Math.abs(_this3.rotate)+_this3.deviation)/(360/_this3.prizeList.length));if(prize==_this3.prizeList.length){prize=0;}
_this3.cb(_this3.prizeList[prize]);clearInterval(_this3.timerInterval);clearTimeout(_this3.timerTimeout);}else{_this3.rotate=_this3.rotate+speed;}
_this3.contentCanvas.style.transform='rotate('+_this3.rotate+'deg)';},100);});}},{key:'rand',value:function rand(n,m){var c=m-n+1;return Math.floor(Math.random()*c+n);}}]);return TurntableCanvas;}();exports.default=TurntableCanvas;